name: Build & Deploy

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata - Frontend
      id: meta-frontend
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
        tags: |
          type=ref,event=branch
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha
    
    - name: Build and push Frontend
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Extract metadata - Backend
      id: meta-backend
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
        tags: |
          type=ref,event=branch
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha
    
    - name: Build and push Backend
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Extract metadata - ML Services
      id: meta-ml
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-ml
        tags: |
          type=ref,event=branch
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha
    
    - name: Build and push ML Services
      uses: docker/build-push-action@v4
      with:
        context: ./ml-services
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta-ml.outputs.tags }}
        labels: ${{ steps.meta-ml.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-staging:
    name: Deploy to Staging
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: build-images
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.panchmukhi.dev
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to staging
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY_STAGING }}
        DEPLOY_HOST: staging.panchmukhi.dev
        DEPLOY_USER: deploy
      run: |
        mkdir -p ~/.ssh
        echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
        
        ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
          cd /app
          docker-compose pull
          docker-compose up -d
          docker-compose exec -T backend npm run migrate
          echo "Deployment complete"
        EOF

  deploy-production:
    name: Deploy to Production
    if: startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push'
    needs: build-images
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://panchmukhi-trading-brain.app
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Create deployment
      uses: actions/github-script@v6
      with:
        script: |
          const deployment = await github.rest.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.ref,
            environment: 'production',
            production_environment: true,
            auto_merge: false
          })
          console.log('Deployment created:', deployment.data.id)
    
    - name: Deploy to production
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY_PRODUCTION }}
        DEPLOY_HOST: api.panchmukhi-trading-brain.app
        DEPLOY_USER: deploy
      run: |
        mkdir -p ~/.ssh
        echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
        
        ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
          cd /app
          # Backup current deployment
          docker-compose exec -T postgres pg_dump panchmukhi_trading > backup_$(date +%s).sql
          
          # Pull latest images
          docker-compose pull
          
          # Start updated services
          docker-compose up -d
          
          # Run migrations
          docker-compose exec -T backend npm run migrate
          
          # Health check
          curl -f http://localhost:8081/health || exit 1
          
          echo "Production deployment complete"
        EOF

  notifications:
    name: Send Notifications
    if: always()
    needs: [build-images]
    runs-on: ubuntu-latest
    
    steps:
    - name: Notify on success
      if: success()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '✅ Build & tests passed!'
          })
    
    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '❌ Build or tests failed. Please review the logs.'
          })
